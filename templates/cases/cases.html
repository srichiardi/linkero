{% extends "base.html" %}

{% block title %}Cases console{% endblock %}

{% block content %}

<div class="row content">
	
	<div class="col-md-10"><!-- first column on the right -->
		<div class="row" id="filter">
			<div class="col-md-10">
				<!-- form goes here! -->
				<form role="form" id="case-filter-form" class="form-inline" action="" method="get">
					{% for field in case_filter_form %}
					<div class="form-group filter-form-group">
						{{ field.label_tag }}{{ field }}
					</div>
					{% endfor %}
					<button type="submit" class="btn btn-default">Filter</button>
				</form>
			</div>
		</div>
		<div class="row" id="cases-list-table">
			<div class="col-md-10">
			<table class="table table-striped" id="cases-list">
				<thead class="text-left">
					<tr>
						<th>Query id</th>
						<th>Platform</th>
						<th>Date</th>
						<th>Query</th>
						<th>Status</th>
					</tr>
				</thead>
				<tbody class="text-left">
					<tr>
						<td>0032651</td>
						<td>eBay</td>
						<td>02-04-2018</td>
						<td>Philips</td>
						<td>completed</td>
					</tr>
					<tr>
						<td>0032653</td>
						<td>MercadoLibre</td>
						<td>23-03-2018</td>
						<td>Bulbs</td>
						<td>completed</td>
					</tr>
					<tr>
						<td>0032851</td>
						<td>Alegro</td>
						<td>10-01-2018</td>
						<td>Tommy Hilfiger</td>
						<td>completed</td>
					</tr>
					<tr>
						<td>0032641</td>
						<td>eBay</td>
						<td>06-02-2018</td>
						<td>Apple</td>
						<td>completed</td>
					</tr>
					<tr>
						<td>0032251</td>
						<td>eBay</td>
						<td>07-05-2018</td>
						<td>Nike</td>
						<td>completed</td>
					</tr>
				</tbody>
			</table>
			</div>
		</div>
		
		<div class="row" id="pager">
		</div>
		
	</div><!-- closing first column -->
	<div class="col-md-2"><!-- second column on the left -->
		<div class="well">
			<div>
				<ul class="nav nav-list">
					<li><label class="tree-toggle nav-header">eBay</label>
						<ul class="nav nav-list tree">
							<li><a data-target="#ebay-listing-modal" data-toggle="modal" href="#ebay-listing-modal">Listings</a></li>
							<li><a href="#">Registration details</a></li>
						</ul>
					</li>
					<li class="divider"></li>
					<li><label class="tree-toggle nav-header">MercadoLibre</label>
						<ul class="nav nav-list tree">
							<li><a href="#">Listings</a></li>
							<li><a href="#">Registration details</a></li>
						</ul>
					</li>
					<li class="divider"></li>
					<li><label class="tree-toggle nav-header">Alegro</label>
						<ul class="nav nav-list tree">
							<li><a href="#">Listings</a></li>
							<li><a href="#">Registration details</a></li>
						</ul>
					</li>
					<li class="divider"></li>
					<li><label class="tree-toggle nav-header">Facebook</label>
						<ul class="nav nav-list tree">
							<li><a href="#">Places</a></li>
							<li><a href="#">Friends</a></li>
							<li><a href="#">Likes</a></li>
						</ul>
					</li>
				</ul>
			</div>
		</div><!-- closing well class -->
	</div><!-- closing second column -->
</div><!-- closing row content -->

<!-- Modals -->
{% include 'cases/ebay_modal_listings.html' %}
<!-- closing modals -->

{% endblock %}

{% block domready %}
<!-- BootStrap DatePicker JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>

<script>
	$(".date-picker").datepicker({format: 'dd/mm/yyyy'});
	
	$('.tree-toggle').click(function () {
		$(this).parent().children('ul.tree').toggle(200);
	});
	
	$('.tree-toggle').parent().children('ul.tree').toggle(1000);
	
	// load the table function
	function get_cases() {
		event.preventDefault();
		var data = $('#case-filter-form').serialize();
		$.get(
				'{% url "cases" %}',
				data,
				function(response) {
					if (response['status'] == 'success') {
						// place cases in a table
						var $casestable = $("#cases-list");
						// clean all table content
						$casestable.children('tbody').empty();
						// populate the table with cases
						for ( i = 0; i < response["cases-list"].length; i++ ) {
							var row = '<tr>';
							row += '<td>' + response["cases-list"][i]['query_id'] + '</td>';
							row += '<td>' + response["cases-list"][i]['platform'] + '</td>';
							row += '<td>' + response["cases-list"][i]['date'] + '</td>';
							row += '<td>' + response["cases-list"][i]['query_title'] + '</td>';
							row += '<td>' + response["cases-list"][i]['query_status'] + '</td>';
							row += '</tr>';
							$casestable.children('tbody').append(row);
						};
					} else {
						// print error message
					}
				}
		);
	};
	
	// post a case with ajax
	$('#ebay-listing-form').submit(function(event) {
		event.preventDefault();
		console.log("form submitted!");  // sanity check
		//var data = $('#ebay-listing-form').serialize(); // trying without serialization
		var data = $('#ebay-listing-form');
		$.post(
				'{% url "cases" %}',
				data,
				function(response){
					if (response['status'] == 'success') {
						// close modal
						// reload table
						get_cases();
					} else {
						// print error message in the modal
					};
				}
		);
	});
	
	
</script>
{% endblock %}
